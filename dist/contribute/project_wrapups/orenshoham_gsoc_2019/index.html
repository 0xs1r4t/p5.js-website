<!DOCTYPE html><html><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1" name=viewport><link href=/_astro/_slug_.C79K3bky.css rel=stylesheet /></head><body><nav><ul><a href=/ >Home</a> <a href=/reference>Reference</a> <a href=/tutorials>Tutorials</a> <a href=/examples>Examples</a> <a href=/community>Community</a> <a href=/about>About</a> <a href=/contribute>Contribute</a></ul></nav><div class="flex space-x-2"><select id=locale-select><option value=/contribute//project_wrapups/orenshoham_gsoc_2019/ selected=true>English</option><option value=/ar/contribute//project_wrapups/orenshoham_gsoc_2019/ >العربية</option><option value=/es/contribute//project_wrapups/orenshoham_gsoc_2019/ >español</option><option value=/hi/contribute//project_wrapups/orenshoham_gsoc_2019/ >हिन्दी</option><option value=/ko/contribute//project_wrapups/orenshoham_gsoc_2019/ >한국어</option><option value=/pt-br/contribute//project_wrapups/orenshoham_gsoc_2019/ >português (Brasil)</option><option value=/sk/contribute//project_wrapups/orenshoham_gsoc_2019/ >slovenčina</option><option value=/zh/contribute//project_wrapups/orenshoham_gsoc_2019/ >中文</option></select><script>document.getElementById("locale-select")?.addEventListener("change",(function(){window.location.href=this.value}))</script><div><form action=/search method=GET role=search><label for=search-term>Search</label> <input aria-label="Search through site content" class="border border-black" id=search-term name=term required type=search> <button type=submit>Search</button></form></div><div>Language: en</div><div>Accessibility</div></div><h1 class="font-bold text-lg">Placeholder title</h1><span></span><main><h1 id=audioworklet-support-in-p5js-sound>AudioWorklet Support in p5.js-sound</h1><p>For my Google Summer of Code 2019 project, I worked with my mentor <a href=https://github.com/therewasaguy>Jason Sigal</a> to add <a href=https://developers.google.com/web/updates/2017/12/audio-worklet>AudioWorklet</a> support to <a href=https://github.com/processing/p5.js-sound>p5.js-sound</a>, allowing certain parts of the library to run more efficiently by moving custom audio processing to a separate audio thread. I also helped Jason integrate <a href=https://webpack.js.org/ >Webpack</a> and <a href=https://babeljs.io/ >Babel</a> into the p5.js-sound <a href=https://gruntjs.com/ >Grunt</a> build pipeline, allowing the library’s developers to use ES6 JavaScript features and laying the groundwork for modernizing the codebase and examples.</p><h2 id=audioworklet>AudioWorklet</h2><p>The AudioWorklet API consists of two classes: <a href=https://developer.mozilla.org/en-US/docs/Web/API/AudioWorkletProcessor>AudioWorkletProcessor</a> and <a href=https://developer.mozilla.org/en-US/docs/Web/API/AudioWorkletNode>AudioWorkletNode</a>. AudioWorkletProcessors contain audio processing code that runs in a separate thread and are meant to be loaded from separate files, while AudioWorkletNodes run on the main thread and are used to connect to other Web Audio nodes.</p><p>AudioWorklet replaces <a href=https://developer.mozilla.org/en-US/docs/Web/API/ScriptProcessorNode>ScriptProcessorNode</a>, a now-deprecated Web Audio node that runs audio code in the browser’s main thread. p5.js-sound used ScriptProcessorNode internally in three classes:</p><ul><li><a href=https://p5js.org/reference/#/p5.SoundFile>p5.SoundFile</a>, which used a ScriptProcessorNode to keep track of a SoundFile’s current playback position.</li><li><a href=https://p5js.org/reference/#/p5.Amplitude>p5.Amplitude</a>, which used a ScriptProcessorNode to perform amplitude analysis.</li><li><a href=https://p5js.org/reference/#/p5.SoundRecorder>p5.SoundRecorder</a>, which used a ScriptProcessorNode to concatenate audio buffers together during the recording process.</li></ul><p>For each of these classes, I created new AudioWorkletProcessors for <a href=https://github.com/processing/p5.js-sound/blob/4d3a3833de4d30f6770740052a82586444a4482a/src/audioWorklet/soundFileProcessor.js>p5.SoundFile</a>, <a href=https://github.com/processing/p5.js-sound/blob/4d3a3833de4d30f6770740052a82586444a4482a/src/audioWorklet/amplitudeProcessor.js>p5.Amplitude</a>, and <a href=https://github.com/processing/p5.js-sound/blob/4d3a3833de4d30f6770740052a82586444a4482a/src/audioWorklet/recorderProcessor.js>p5.SoundRecorder</a> that replicated the corresponding ScriptProcessorNode’s <a href=https://developer.mozilla.org/en-US/docs/Web/API/ScriptProcessorNode/onaudioprocess>onaudioprocess</a> function.</p><h3 id=audioworkletprocessors-and-async-loading>AudioWorkletProcessors and Async Loading</h3><p>Before these AudioWorkletProcessors could be used as AudioWorkletNodes, they needed be loaded asynchronously via a call to <a href=https://developer.mozilla.org/en-US/docs/Web/API/Worklet/addModule><code>audioWorklet.addModule()</code></a>, which expects a URL pointing to the file containing the processor definition.</p><p>This presented a problem: p5.js-sound is typically included in sketches as a single file, so I couldn’t load the worklet processors as separate files. The solution was to convert the source for each AudioWorkletProcessor into a string using Webpack’s <a href=https://github.com/webpack-contrib/raw-loader>raw-loader</a> (see <a href=#webpack-and-es6>Webpack and ES6</a> below for more details), then construct a <a href=https://developer.mozilla.org/en-US/docs/Web/API/Blob>Blob</a> from that string and generate an <a href=https://developer.mozilla.org/en-US/docs/Web/API/URL/createObjectURL>object URL</a> for the Blob which could be passed into <code>audioWorklet.addModule()</code>.</p><pre class="astro-code github-dark" style=background-color:#24292e;color:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#f97583>function</span><span style=color:#b392f0> loadAudioWorkletModules</span><span style=color:#e1e4e8>() {</span></span>
<span class=line><span style=color:#f97583>  return</span><span style=color:#79b8ff> Promise</span><span style=color:#e1e4e8>.</span><span style=color:#b392f0>all</span><span style=color:#e1e4e8>(moduleSources.</span><span style=color:#b392f0>map</span><span style=color:#e1e4e8>(</span><span style=color:#f97583>function</span><span style=color:#e1e4e8>(</span><span style=color:#ffab70>moduleSrc</span><span style=color:#e1e4e8>) {</span></span>
<span class=line><span style=color:#f97583>    const</span><span style=color:#79b8ff> blob</span><span style=color:#f97583> =</span><span style=color:#f97583> new</span><span style=color:#b392f0> Blob</span><span style=color:#e1e4e8>([moduleSrc], { type: </span><span style=color:#9ecbff>&#39;application/javascript&#39;</span><span style=color:#e1e4e8> });</span></span>
<span class=line><span style=color:#f97583>    const</span><span style=color:#79b8ff> objectURL</span><span style=color:#f97583> =</span><span style=color:#79b8ff> URL</span><span style=color:#e1e4e8>.</span><span style=color:#b392f0>createObjectURL</span><span style=color:#e1e4e8>(blob);</span></span>
<span class=line><span style=color:#f97583>    return</span><span style=color:#e1e4e8> ac.audioWorklet.</span><span style=color:#b392f0>addModule</span><span style=color:#e1e4e8>(objectURL);</span></span>
<span class=line><span style=color:#e1e4e8>  }));</span></span>
<span class=line><span style=color:#e1e4e8>}</span></span></code></pre><p>To play nicely with the rest of p5.js, the AudioWorkletProcessors needed to be loaded before a sketch’s <code>setup()</code> function, during <code>preload()</code>. However, I didn’t want to force users to write a <code>preload()</code> function every time they made a sketch with p5.js-sound, as that would break existing sketches and make the library harder to use.</p><p>The (slightly-hacky) solution that I arrived at was to register a function with the p5.js <a href=https://github.com/processing/p5.js/blob/main/contributor_docs/creating_libraries.md#use-registermethod-to-register-functions-with-p5-that-should-be-called-at-various-times>“init” hook</a> that first ensured that a <code>preload()</code> function was defined on the sketch, then incremented p5.js’s internal preload counter to get <code>preload()</code> to wait for all of the processor modules to load:</p><pre class="astro-code github-dark" style=background-color:#24292e;color:#e1e4e8;overflow-x:auto tabindex=0><code><span class=line><span style=color:#79b8ff>p5</span><span style=color:#e1e4e8>.</span><span style=color:#79b8ff>prototype</span><span style=color:#e1e4e8>.</span><span style=color:#b392f0>registerMethod</span><span style=color:#e1e4e8>(</span><span style=color:#9ecbff>&#39;init&#39;</span><span style=color:#e1e4e8>, </span><span style=color:#f97583>function</span><span style=color:#e1e4e8>() {</span></span>
<span class=line><span style=color:#6a737d>  // ensure that a preload function exists so that p5 will wait for preloads to finish</span></span>
<span class=line><span style=color:#f97583>  if</span><span style=color:#e1e4e8> (</span><span style=color:#f97583>!</span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>.preload </span><span style=color:#f97583>&amp;&amp;</span><span style=color:#f97583> !</span><span style=color:#e1e4e8>window.preload) {</span></span>
<span class=line><span style=color:#79b8ff>    this</span><span style=color:#e1e4e8>.</span><span style=color:#b392f0>preload</span><span style=color:#f97583> =</span><span style=color:#f97583> function</span><span style=color:#e1e4e8>() {};</span></span>
<span class=line><span style=color:#e1e4e8>  }</span></span>
<span class=line><span style=color:#6a737d>  // use p5&#39;s preload system to load necessary AudioWorklet modules before setup()</span></span>
<span class=line><span style=color:#79b8ff>  this</span><span style=color:#e1e4e8>._preloadCount</span><span style=color:#f97583>++</span><span style=color:#e1e4e8>;</span></span>
<span class=line><span style=color:#f97583>  const</span><span style=color:#b392f0> onWorkletModulesLoad</span><span style=color:#f97583> =</span><span style=color:#f97583> function</span><span style=color:#e1e4e8>() {</span></span>
<span class=line><span style=color:#79b8ff>    this</span><span style=color:#e1e4e8>.</span><span style=color:#b392f0>_decrementPreload</span><span style=color:#e1e4e8>();</span></span>
<span class=line><span style=color:#e1e4e8>  }.</span><span style=color:#b392f0>bind</span><span style=color:#e1e4e8>(</span><span style=color:#79b8ff>this</span><span style=color:#e1e4e8>);</span></span>
<span class=line><span style=color:#b392f0>  loadAudioWorkletModules</span><span style=color:#e1e4e8>().</span><span style=color:#b392f0>then</span><span style=color:#e1e4e8>(onWorkletModulesLoad);</span></span>
<span class=line><span style=color:#e1e4e8>});</span></span></code></pre><p>This approach is probably a little too dependent on p5.js’s internal workings, but it might be useful for other p5.js library developers running into similar asynchronous loading issues in the future.</p><h3 id=polyfill>Polyfill</h3><p>To avoid breaking p5.js-sound in browsers like Firefox and Safari that haven’t yet implemented the AudioWorklet API, I added a <a href=https://github.com/GoogleChromeLabs/audioworklet-polyfill>polyfill</a> to the library that falls back to ScriptProcessorNode in unsupported browsers.</p><h3 id=ring-buffers>Ring Buffers</h3><p>AudioWorklet processors use a fixed buffer size of 128 frames, unlike ScriptProcessorNodes which take a buffer size as an argument. A lower buffer size will generally result in lower latency but also higher CPU usage.</p><p>To allow for more control over the buffer sizes of the various AudioWorkletNodes in p5.js-sound, I added a ring buffer (adapted from some of <a href=https://github.com/GoogleChromeLabs/web-audio-samples/blob/7ee9a21f224a7fd5093cf1b3ec13fa958d97fa4c/audio-worklet/design-pattern/lib/wasm-audio-helper.js#L170>Google Chrome Labs’ sample code</a>) to each AudioWorkletProcessor which accumulates frames of audio until the desired buffer size has been reached. For more details on this approach, see the “Handling Buffer Size Mismatch” section of the article <a href=https://developers.google.com/web/updates/2018/06/audio-worklet-design-pattern#handling_buffer_size_mismatch>Audio Worklet Design Patterns</a>.</p><h2 id=webpack-and-es6>Webpack and ES6</h2><p>As mentioned above, loading AudioWorkletProcessor modules as strings was made much easier by including Webpack in the p5.js-sound build pipeline. Since ES6 JavaScript support had been on the p5.js-sound to-do list for a while, Jason and I decided to pair on integrating Webpack and Babel into the p5.js-sound Grunt build configuration. This involved replacing <a href=https://github.com/gruntjs/grunt-contrib-requirejs>requirejs</a> with <a href=https://github.com/webpack-contrib/grunt-webpack>grunt-webpack</a> and adding a <a href=https://github.com/processing/p5.js-sound/blob/4d3a3833de4d30f6770740052a82586444a4482a/webpack.config.js>Webpack config</a>. This change allows p5.js-sound developers to use ES6 features throughout the codebase, along with source maps for easier debugging of compiled ES6 code in the browser.</p><p>Unfortunately, the additional comments inserted by Webpack into the compiled bundle had the side-effect of breaking the p5.js-sound documentation generated from <a href=https://yui.github.io/yuidoc/ >YUIDoc</a> comments. Jason is currently in the process of fixing this issue by extracting the YUIDoc comments into a separate file during the build. Progress on this can be followed in <a href=https://github.com/processing/p5.js-sound/pull/377>PR #377</a>.</p><h2 id=contributions>Contributions</h2><ul><li><p><a href=https://github.com/processing/p5.js-sound/pull/364>Add tests for p5.SoundRecorder and lint existing tests (#364)</a></p></li><li><p><a href=https://github.com/processing/p5.js-sound/pull/366>Replace requirejs with webpack to enable ES6+ and non-AMD modules (#366)</a></p></li><li><p><a href=https://github.com/processing/p5.js-sound/pull/369>Replace ScriptProcessorNode in p5.SoundRecorder with AudioWorkletNode (#369)</a></p></li><li><p><a href=https://github.com/processing/p5.js-sound/pull/373>Replace ScriptProcessorNode with AudioWorkletNode in p5.SoundFile and p5.Amplitude (#373)</a></p></li><li><p><a href=https://github.com/processing/p5.js-sound/pull/376>Add ring buffers to AudioWorklet processors to support variable buffer sizes (#376)</a></p></li><li><p><a href=https://github.com/processing/p5.js-sound/pull/380>Bugfixes for p5.Amplitude and p5.Soundfile for browsers without AudioWorklet support (#380)</a></p></li></ul><h2 id=acknowledgements>Acknowledgements</h2><p>I’m extremely grateful to the Processing Foundation for giving me the opportunity to contribute to p5.js, as well as to my mentor Jason Sigal for all of his support over the course of this project.</p></main><div>p5.js site footer goes here</div></body></html>